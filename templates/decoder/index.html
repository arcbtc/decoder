{% extends "base.html" %} {% from "macros.jinja" import window_vars with context
%} {% block page %}

<div class="row q-col-gutter-md">
  <div class="col-12 col-md-7 q-gutter-y-md">
    <q-card flat>
    <q-card-section>
    <div class="row items-center no-wrap q-mb-sm">
      <div class="col">
        <strong>
          Decode Lightning
          BOLT11, LNURL, and Lightning Address
        </strong>
      </div>
    </div>
    <div class="row items-center no-wrap q-mb-sm">
      <div class="col">
        <q-form @submit="sendFormData" class="q-gutter-md">
        <q-input 
          filled 
          dense 
          clearable 
          placeholder="Enter Invoice...." 
          v-model.trim="invoice" 
          label="invoice"
          class="q-mb-md">
        </q-input>
        <q-btn unelevated color="primary" type="submit">Go</q-btn>
        </q-form>
      </div>
    </div>
    </q-card-section>
    </q-card>

    <q-card>
      <q-card-section>
        <p>
          <b>Decoded Data</b><br />
        </p>
        <div>{% raw %} {{ decoderData }} {% endraw %}</div>
      </q-card-section>
    </q-card>
    
    <q-card>       
      <q-table
      :data="tasks"
      row-key="name"
      flat
      dense
      >
      </q-table>

    </q-card>
  </div>

  <div class="col-12 col-md-5 q-gutter-y-md">
    <q-card>
      <q-card-section>
        <h6 class="text-subtitle1 q-my-none">
          {{ SITE_TITLE }} Decoder extension
        </h6>
      </q-card-section>
      <q-card-section class="q-pa-none">
        <q-separator></q-separator>
        <q-list>
          {% include "decoder/_decoder.html" %}
        </q-list>
      </q-card-section>
    </q-card>
  </div>

</div>
{% endblock %} {% block scripts %} {{ window_vars(user) }}

<script>
  var someMapObject = obj => {
    obj._data = _.clone(obj)
    obj.date = Quasar.utils.date.formatDate(
      new Date(obj.time * 1000),
      'YYYY-MM-DD HH:mm'
    )
    // here you can do something with the mapped data
    return obj
  }
  new Vue({
    el: '#vue',
    mixins: [windowMixin],
    computed: {
      endpoint: function() {
        return `/decoder/api/v1/settings?usr=${this.g.user.id}`
      }
    },  
    data: function () {
      return {
        decoderData: [],
        invoice: '',
        tasks: [
        {
          Key: "field one", 
          Value: "100", 
          
        },
        {
          Key: "field two",
          Value: "200"
        }],
      }
    },
    ///// Where functions live /////
    methods: {
      sendFormData() { 
        var info = this.decoderFunction({"data": this.invoice})
      },
      
      decoderFunction: function (data) {
        var theData = data
        // console.log("data: ", theData)
        LNbits.api
          .request(
            'POST', 
            '/api/v1/payments/decode' , 
            this.g.user.wallets[0].inkey,
            data
          )
          .then(response => {

            console.log("response: ", response.data)
            this.decoderData = response.data
            // const arrayFromObject = Object.entries(response.data);
            // console.log("array object", arrayFromObject)

            console.log("")
            const responseObject = response.data;
            const arrayFromResponse = Object.entries(responseObject).map(([key, value]) => ({
              title: key,
              amount: value.toString()
            }));            
            console.log(arrayFromResponse);
            this.tasks = arrayFromResponse
            

          })
          .catch(error => {
            LNbits.utils.notifyApiError(error) // Error will be passed to the frontend
          })
      },      
    },
    ///// To run on startup /////
    created: function () {
      self = this
    }
  })
</script>
{% endblock %}